local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local MarketplaceService = game:GetService("MarketplaceService")
local StarterGui = game:GetService("StarterGui")
local CoreGui = game:GetService("CoreGui")
local ContextActionService = game:GetService("ContextActionService")
local UserInputService = game:GetService("UserInputService")

local Emotes = {}
local LoadedEmotes = {}

local IsLoaded = false -- Track if emote frame is shown

-- Destroy any existing GUI instances if the script runs again
if CoreGui:FindFirstChild("CustomEmotesGui") then
    CoreGui:FindFirstChild("CustomEmotesGui"):Destroy()
end

-- Create main GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CustomEmotesGui"
ScreenGui.Parent = CoreGui

-- Loading frame
local LoadingFrame = Instance.new("Frame", ScreenGui)
LoadingFrame.Size = UDim2.new(0.3, 0, 0.1, 0)
LoadingFrame.Position = UDim2.new(0.35, 0, 0.1, 0)
LoadingFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
LoadingFrame.BackgroundTransparency = 0.5
LoadingFrame.BorderSizePixel = 0

local UICorner = Instance.new("UICorner", LoadingFrame)
UICorner.CornerRadius = UDim.new(0.2, 0)

-- Loading text
local LoadingText = Instance.new("TextLabel", LoadingFrame)
LoadingText.Size = UDim2.new(1, 0, 1, 0)
LoadingText.Text = "Loading..."
LoadingText.TextColor3 = Color3.fromRGB(255, 255, 255)
LoadingText.Font = Enum.Font.GothamBold
LoadingText.TextScaled = true
LoadingText.BackgroundTransparency = 1

-- Toggle button to show and hide the emote GUI
local ToggleButton = Instance.new("TextButton", ScreenGui)
ToggleButton.Size = UDim2.new(0.1, 0, 0.05, 0)
ToggleButton.Position = UDim2.new(0.9, -50, 0.9, -50)
ToggleButton.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
ToggleButton.BackgroundTransparency = 0.5
ToggleButton.Text = "Show Emotes"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.TextScaled = true
local ToggleCorner = Instance.new("UICorner", ToggleButton)
ToggleCorner.CornerRadius = UDim.new(0.2, 0)

-- Main scrollable frame for emotes
local MainFrame = Instance.new("ScrollingFrame", ScreenGui)
MainFrame.Size = UDim2.new(0.6, 0, 0.6, 0)
MainFrame.Position = UDim2.new(0.2, 0, 0.2, 0)
MainFrame.BackgroundTransparency = 0.5
MainFrame.ScrollBarThickness = 5
MainFrame.Visible = false -- Hidden initially
MainFrame.CanvasSize = UDim2.new(0, 0, 1, 0) -- Initial canvas size

-- UI grid layout for buttons
local EmoteGrid = Instance.new("UIGridLayout", MainFrame)
EmoteGrid.CellSize = UDim2.new(0.15, 0, 0.15, 0)
EmoteGrid.CellPadding = UDim2.new(0.01, 0, 0.01, 0)
EmoteGrid.SortOrder = Enum.SortOrder.LayoutOrder

-- Add emotes after loading
local function AddEmote(name, id, icon)
    table.insert(Emotes, {
        name = name,
        id = id,
        icon = icon
    })
end

-- Function to create emote buttons
local function CreateEmoteButtons()
    for _, emote in pairs(Emotes) do
        local EmoteButton = Instance.new("TextButton", MainFrame)
        EmoteButton.Size = UDim2.new(0.15, 0, 0.15, 0)
        EmoteButton.Text = ""
        EmoteButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        EmoteButton.BackgroundTransparency = 0.5
        EmoteButton.BorderSizePixel = 0

        local UICorner = Instance.new("UICorner", EmoteButton)
        UICorner.CornerRadius = UDim.new(0.2, 0)

        -- Add emote image
        local EmoteImage = Instance.new("ImageLabel", EmoteButton)
        EmoteImage.Size = UDim2.new(0.8, 0, 0.8, 0)
        EmoteImage.Position = UDim2.new(0.1, 0, 0.1, 0)
        EmoteImage.Image = emote.icon
        EmoteImage.BackgroundTransparency = 1

        -- Play emote on click
        EmoteButton.MouseButton1Click:Connect(function()
            local Humanoid = Players.LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
            if Humanoid and Humanoid.RigType == Enum.HumanoidRigType.R15 then
                pcall(function()
                    Humanoid:PlayEmoteAndGetAnimTrackById(emote.id)
                end)
                MainFrame.Visible = false -- Hide frame when emote is selected
                ToggleButton.Text = "Show Emotes" -- Reset the toggle button text
            end
        end)
    end

    -- Update ScrollFrame canvas size to fit all buttons
    MainFrame.CanvasSize = UDim2.new(0, 0, 0, EmoteGrid.AbsoluteContentSize.Y + 10)
end

-- Toggle emote GUI visibility
ToggleButton.MouseButton1Click:Connect(function()
    IsLoaded = not IsLoaded
    MainFrame.Visible = IsLoaded
    ToggleButton.Text = IsLoaded and "Hide Emotes" or "Show Emotes"
end)

-- Load all emotes
local function LoadEmotes()
    local success, Response = pcall(function()
        return game:HttpGetAsync("https://catalog.roblox.com/v1/search/items/details?Category=12&Subcategory=39&SortType=1&limit=30")
    end)

    if success then
        local Body = HttpService:JSONDecode(Response)
        for _, emoteData in pairs(Body.data) do
            AddEmote(emoteData.name, emoteData.id, "rbxthumb://type=Asset&id="..emoteData.id.."&w=150&h=150")
        end
    end
end

-- Wait until all emotes are loaded
spawn(function()
    LoadEmotes()
    while #Emotes == 0 do
        wait(0.5) -- Show loading if no emotes have been loaded yet
    end
    -- After loading, destroy loading frame and create buttons
    LoadingFrame:Destroy()
    CreateEmoteButtons()
end)
