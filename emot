local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")
local CoreGui = game:GetService("CoreGui")
local MarketplaceService = game:GetService("MarketplaceService")

local LocalPlayer = Players.LocalPlayer
local Emotes = {}
local FavoriteEmotes = {}
local LoadedEmotes = {}
local IsLoaded = false
local Cursor = ""

-- Destroy old instances if the script is executed twice
if CoreGui:FindFirstChild("CustomEmotesGui") then
    CoreGui:FindFirstChild("CustomEmotesGui"):Destroy()
end

-- Main GUI setup
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "CustomEmotesGui"
ScreenGui.Parent = CoreGui

-- Loading frame
local LoadingFrame = Instance.new("Frame", ScreenGui)
LoadingFrame.Size = UDim2.new(0.3, 0, 0.1, 0)
LoadingFrame.Position = UDim2.new(0.35, 0, 0.1, 0)
LoadingFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
LoadingFrame.BackgroundTransparency = 0.5
LoadingFrame.BorderSizePixel = 0

local UICorner = Instance.new("UICorner", LoadingFrame)
UICorner.CornerRadius = UDim.new(0.2, 0)

-- Loading text
local LoadingText = Instance.new("TextLabel", LoadingFrame)
LoadingText.Size = UDim2.new(1, 0, 1, 0)
LoadingText.Text = "Loading..."
LoadingText.TextColor3 = Color3.fromRGB(255, 255, 255)
LoadingText.Font = Enum.Font.GothamBold
LoadingText.TextScaled = true
LoadingText.BackgroundTransparency = 1

-- Toggle button to show and hide the emote GUI
local ToggleButton = Instance.new("TextButton", ScreenGui)
ToggleButton.Size = UDim2.new(0.1, 0, 0.05, 0)
ToggleButton.Position = UDim2.new(0.9, -50, 0.9, -50)
ToggleButton.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
ToggleButton.BackgroundTransparency = 0.5
ToggleButton.Text = "Show Emotes"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.TextScaled = true
local ToggleCorner = Instance.new("UICorner", ToggleButton)
ToggleCorner.CornerRadius = UDim.new(0.2, 0)

-- Main scrollable frame for emotes
local MainFrame = Instance.new("ScrollingFrame", ScreenGui)
MainFrame.Size = UDim2.new(0.6, 0, 0.6, 0)
MainFrame.Position = UDim2.new(0.2, 0, 0.2, 0)
MainFrame.BackgroundTransparency = 0.5
MainFrame.ScrollBarThickness = 5
MainFrame.Visible = false -- Hide initially
MainFrame.CanvasSize = UDim2.new(0, 0, 1, 0) -- Set initial canvas size

-- UI grid layout for buttons
local EmoteGrid = Instance.new("UIGridLayout", MainFrame)
EmoteGrid.CellSize = UDim2.new(0.15, 0, 0.15, 0)
EmoteGrid.CellPadding = UDim2.new(0.01, 0, 0.01, 0)
EmoteGrid.SortOrder = Enum.SortOrder.LayoutOrder

-- Add emotes after everything is loaded
local function AddEmote(name, id, icon)
    table.insert(Emotes, {
        name = name,
        id = id,
        icon = icon
    })
end

-- Function to create emote buttons
local function CreateEmoteButtons()
    for _, emote in pairs(Emotes) do
        local EmoteButton = Instance.new("TextButton", MainFrame)
        EmoteButton.Size = UDim2.new(0.15, 0, 0.15, 0)
        EmoteButton.Text = ""
        EmoteButton.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        EmoteButton.BackgroundTransparency = 0.5
        EmoteButton.BorderSizePixel = 0

        local UICorner = Instance.new("UICorner", EmoteButton)
        UICorner.CornerRadius = UDim.new(0.2, 0)

        -- Add emote image
        local EmoteImage = Instance.new("ImageLabel", EmoteButton)
        EmoteImage.Size = UDim2.new(0.8, 0, 0.8, 0)
        EmoteImage.Position = UDim2.new(0.1, 0, 0.1, 0)
        EmoteImage.Image = emote.icon
        EmoteImage.BackgroundTransparency = 1

        -- Play emote on click
        EmoteButton.MouseButton1Click:Connect(function()
            local Humanoid = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
            if Humanoid and Humanoid.RigType == Enum.HumanoidRigType.R15 then
                pcall(function()
                    Humanoid:PlayEmoteAndGetAnimTrackById(emote.id)
                end)
                MainFrame.Visible = false -- Hide frame when emote is selected
                ToggleButton.Text = "Show Emotes" -- Reset the toggle button text
            end
        end)

        -- Favorite button
        local FavoriteButton = Instance.new("TextButton", EmoteButton)
        FavoriteButton.Size = UDim2.new(0.3, 0, 0.3, 0)
        FavoriteButton.Position = UDim2.new(0.65, 0, 0.1, 0)
        FavoriteButton.BackgroundColor3 = Color3.fromRGB(255, 215, 0)
        FavoriteButton.Text = "‚≠ê"
        FavoriteButton.TextScaled = true
        FavoriteButton.TextColor3 = Color3.new(1, 1, 1)
        FavoriteButton.BackgroundTransparency = 0.5
        FavoriteButton.BorderSizePixel = 0

        local FavoriteCorner = Instance.new("UICorner", FavoriteButton)
        FavoriteCorner.CornerRadius = UDim.new(0.5, 0)

        -- Add to favorites
        FavoriteButton.MouseButton1Click:Connect(function()
            if not table.find(FavoriteEmotes, emote.id) then
                table.insert(FavoriteEmotes, emote.id)
                writefile("FavoritedEmotes.txt", HttpService:JSONEncode(FavoriteEmotes))
            end
        end)
    end

    -- Update ScrollFrame canvas size to accommodate all buttons
    MainFrame.CanvasSize = UDim2.new(0, 0, 0, EmoteGrid.AbsoluteContentSize.Y + 10)
end

-- Toggle the emote GUI visibility
ToggleButton.MouseButton1Click:Connect(function()
    IsLoaded = not IsLoaded
    MainFrame.Visible = IsLoaded
    ToggleButton.Text = IsLoaded and "Hide Emotes" or "Show Emotes"
end)

-- Function to load emotes from the API
local function LoadEmotes()
    local success, Response = pcall(function()
        return game:HttpGetAsync("https://catalog.roblox.com/v1/search/items/details?Category=12&Subcategory=39&SortType=1&limit=30")
    end)

    if success then
        local Body = HttpService:JSONDecode(Response)
        for _, emoteData in pairs(Body.data) do
            AddEmote(emoteData.name, emoteData.id, "rbxthumb://type=Asset&id="..emoteData.id.."&w=150&h=150")
        end
    end
end

-- Start loading emotes
LoadEmotes()

-- Wait for all emotes to load before showing GUI
spawn(function()
    while #Emotes == 0 do
        LoadingText.Text = "Loading..."
        wait(0.5)
    end
    -- Animate frame and text disappearance
    TweenService:Create(LoadingFrame, TweenInfo.new(1), {BackgroundTransparency = 1}):Play()
    TweenService:Create(LoadingText, TweenInfo.new(1), {TextTransparency = 1}):Play()
    wait(1)
    LoadingFrame:Destroy()

    CreateEmoteButtons() -- Now create the buttons after loading
end)
